--- a/modules/e2sr/gaussian_query.py
+++ b/modules/e2sr/gaussian_query.py
@@ -188,9 +188,24 @@ class GaussianQueryModule(nn.Module):
         xx, yy = ax_batch_expanded_x, ax_batch_expanded_y
         xy = torch.stack([xx, yy], dim=-1)  # [num_LR_points, k, k, 2]

-        # 5.3 计算高斯值
-        z = torch.einsum('b...i,bij,b...j->b...', xy, -0.5 * inv_covariance, xy)
+        # 5.3 计算高斯值（马氏距离）
+        # xy: [num_LR_points, k, k, 2]
+        # inv_covariance: [num_LR_points, 2, 2]
+        # 需要计算: z = -0.5 * xy @ inv_covariance @ xy^T
+
+        # 重塑 xy 为 [num_LR_points, k*k, 2]
+        xy_flat = xy.reshape(num_LR_points, -1, 2)
+
+        # 计算 xy @ inv_covariance: [num_LR_points, k*k, 2]
+        temp = torch.matmul(xy_flat, -0.5 * inv_covariance)
+
+        # 计算内积: [num_LR_points, k*k]
+        z_flat = (temp * xy_flat).sum(dim=-1)
+
+        # 重塑回 [num_LR_points, k, k]
+        z = z_flat.reshape(num_LR_points, self.kernel_size, self.kernel_size)
+
         kernel = torch.exp(z) / (
             2 * torch.tensor(np.pi, device=device) *
             torch.sqrt(torch.det(covariance)).to(device).view(num_LR_points, 1, 1)
         )

# ============================================================
# 高斯查询 einsum 维度修复
# ============================================================
#
# 问题: RuntimeError: einsum(): the number of subscripts in the equation (3)
#       does not match the number of dimensions (5) for operand 1
#
# 原因: einsum 公式 'b...i,bij,b...j->b...' 在处理多维张量时不够明确
#       导致维度推断错误
#
# 解决: 使用显式的矩阵乘法替代 einsum，步骤清晰且高效：
#       1. 将 xy 从 [N, K, K, 2] 重塑为 [N, K*K, 2]
#       2. 计算 xy @ inv_covariance
#       3. 计算内积得到马氏距离
#       4. 重塑回 [N, K, K]
#
# 应用方法:
#   方法 1: 运行自动修复脚本
#     bash quick_fix_einsum.sh
#
#   方法 2: 手动替换
#     编辑 modules/e2sr/gaussian_query.py 第 191-196 行
#     将单行 einsum 替换为多行矩阵乘法（见上方补丁）
#
# ============================================================
